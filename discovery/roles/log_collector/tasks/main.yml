---
# log_collector role: stage-driven tasks

- name: Load log path variables
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/log_paths.yml"
  run_once: true

- name: Set timestamp (IST)
  when: stage == 'setup'
  run_once: true
  ansible.builtin.set_fact:
    log_ts: "{{ lookup('pipe', 'TZ=Asia/Kolkata date +%Y%m%dT%H%M%S') }}"
    log_root: "{{ log_root }}"
    k8s_master_log_dirs: "{{ k8s_master_log_dirs }}"
    k8s_master_log_files: "{{ k8s_master_log_files }}"
    k8s_worker_log_files: "{{ k8s_worker_log_files }}"
    slurm_ctl_log_dirs: "{{ slurm_ctl_log_dirs }}"
    slurm_ctl_log_files: "{{ slurm_ctl_log_files }}"
    slurm_node_log_dirs: "{{ slurm_node_log_dirs }}"
    slurm_node_log_files: "{{ slurm_node_log_files }}"

- name: Parse mapping and build groups
  when: stage == 'prepare'
  block:
    - name: Read mapping file content
      ansible.builtin.set_fact:
        mapping_content: "{{ lookup('file', pxe_mapping_file_path) }}"

    - name: Parse mapping CSV using shell
      ansible.builtin.shell: |
        python3 << 'EOF'
        import csv
        import json
        entries = []
        with open('{{ pxe_mapping_file_path }}', 'r') as f:
            reader = csv.DictReader(f)
            for row in reader:
                entries.append(row)
        print(json.dumps(entries))
        EOF
      register: csv_parse_result
      changed_when: false

    - name: Set mapping entries from parsed CSV
      ansible.builtin.set_fact:
        mapping_entries: "{{ csv_parse_result.stdout | from_json }}"

    - name: Build k8s masters list (functional groups starting with service_kube_control_plane)
      ansible.builtin.set_fact:
        k8s_masters: "{{ mapping_entries | selectattr('FUNCTIONAL_GROUP_NAME', 'search', '^service_kube_control_plane') | list }}"

    - name: Build k8s workers list (functional groups starting with service_kube_node)
      ansible.builtin.set_fact:
        k8s_workers: "{{ mapping_entries | selectattr('FUNCTIONAL_GROUP_NAME', 'search', '^service_kube_node') | list }}"

    - name: Build slurm controllers list (functional groups starting with slurm_control_node)
      ansible.builtin.set_fact:
        slurm_controllers: "{{ mapping_entries | selectattr('FUNCTIONAL_GROUP_NAME', 'search', '^slurm_control_node') | list }}"

    - name: Build slurm nodes list (functional groups starting with slurm_node)
      ansible.builtin.set_fact:
        slurm_nodes: "{{ mapping_entries | selectattr('FUNCTIONAL_GROUP_NAME', 'search', '^slurm_node') | list }}"

    - name: Add dynamic hosts for k8s masters
      ansible.builtin.add_host:
        name: "{{ item.HOSTNAME }}"
        ansible_host: "{{ item.ADMIN_IP }}"
        groups: k8s_masters
      loop: "{{ k8s_masters }}"

    - name: Print all k8s_masters hostnames
      ansible.builtin.debug:
        msg: "K8s Masters Group - Hostname: {{ item.HOSTNAME }}, IP: {{ item.ADMIN_IP }}"
      loop: "{{ k8s_masters }}"

    - name: Add dynamic hosts for k8s workers
      ansible.builtin.add_host:
        name: "{{ item.HOSTNAME }}"
        ansible_host: "{{ item.ADMIN_IP }}"
        groups: k8s_workers
      loop: "{{ k8s_workers }}"

    - name: Add dynamic hosts for slurm controllers
      ansible.builtin.add_host:
        name: "{{ item.HOSTNAME }}"
        ansible_host: "{{ item.ADMIN_IP }}"
        groups: slurm_controllers
      loop: "{{ slurm_controllers }}"

    - name: Print all slurm_controllers hostnames
      ansible.builtin.debug:
        msg: "Slurm Controllers Group - Hostname: {{ item.HOSTNAME }}, IP: {{ item.ADMIN_IP }}"
      loop: "{{ slurm_controllers }}"

    - name: Add dynamic hosts for slurm nodes
      ansible.builtin.add_host:
        name: "{{ item.HOSTNAME }}"
        ansible_host: "{{ item.ADMIN_IP }}"
        groups: slurm_nodes
      loop: "{{ slurm_nodes }}"

    - name: Print all slurm_nodes hostnames
      ansible.builtin.debug:
        msg: "Slurm Nodes Group - Hostname: {{ item.HOSTNAME }}, IP: {{ item.ADMIN_IP }}"
      loop: "{{ slurm_nodes }}"

    - name: Ensure log directories exist on OIM
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ log_root }}"
        - "{{ log_root }}/k8s"
        - "{{ log_root }}/slurm"

- name: Collect k8s master logs
  when: stage == 'k8s_master'
  block:
    - name: Stat k8s master log directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: k8s_master_dir_stat
      with_items: "{{ hostvars['localhost'].k8s_master_log_dirs | default(k8s_master_log_dirs, true) }}"

    - name: Find files under existing k8s master log directories
      ansible.builtin.find:
        paths: "{{ item.item }}"
        file_type: file
        recurse: true
      register: k8s_master_found_files
      when: item.stat.isdir | default(false)
      with_items: "{{ k8s_master_dir_stat.results }}"

    - name: Fetch files from k8s master log directories
      ansible.builtin.fetch:
        src: "{{ item }}"
        dest: "{{ hostvars['localhost'].log_root }}/k8s/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      loop: "{{ k8s_master_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | map(attribute='path') | list }}"
      when: k8s_master_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | length > 0

    - name: Stat k8s master log files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: k8s_master_files
      with_items: "{{ hostvars['localhost'].k8s_master_log_files | default(k8s_master_log_files, true) }}"

    - name: Fetch k8s master log files
      ansible.builtin.fetch:
        src: "{{ item.item }}"
        dest: "{{ hostvars['localhost'].log_root }}/k8s/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      when: item.stat.isreg | default(false)
      with_items: "{{ k8s_master_files.results }}"

- name: Collect k8s worker logs
  when: stage == 'k8s_worker'
  block:
    - name: Stat k8s worker log files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: k8s_worker_files
      with_items: "{{ hostvars['localhost'].k8s_worker_log_files | default(k8s_worker_log_files, true) }}"

    - name: Fetch k8s worker log files
      ansible.builtin.fetch:
        src: "{{ item.item }}"
        dest: "{{ hostvars['localhost'].log_root }}/k8s/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      when: item.stat.isreg | default(false)
      with_items: "{{ k8s_worker_files.results }}"

- name: Collect slurm controller logs
  when: stage == 'slurm_ctl'
  block:
    - name: Stat slurm controller log directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: slurm_ctl_dir_stat
      with_items: "{{ hostvars['localhost'].slurm_ctl_log_dirs | default(slurm_ctl_log_dirs, true) }}"

    - name: Find files under existing slurm controller log directories
      ansible.builtin.find:
        paths: "{{ item.item }}"
        file_type: file
        recurse: true
      register: slurm_ctl_found_files
      when: item.stat.isdir | default(false)
      with_items: "{{ slurm_ctl_dir_stat.results }}"

    - name: Fetch files from slurm controller log directories
      ansible.builtin.fetch:
        src: "{{ item }}"
        dest: "{{ hostvars['localhost'].log_root }}/slurm/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      loop: "{{ slurm_ctl_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | map(attribute='path') | list }}"
      when: slurm_ctl_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | length > 0

    - name: Stat slurm controller log files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: slurm_ctl_files
      with_items: "{{ hostvars['localhost'].slurm_ctl_log_files | default(slurm_ctl_log_files, true) }}"

    - name: Fetch slurm controller log files
      ansible.builtin.fetch:
        src: "{{ item.item }}"
        dest: "{{ hostvars['localhost'].log_root }}/slurm/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      when: item.stat.isreg | default(false)
      with_items: "{{ slurm_ctl_files.results }}"

- name: Collect slurm node logs
  when: stage == 'slurm_node'
  block:
    - name: Stat slurm node log directories
      ansible.builtin.stat:
        path: "{{ item }}"
      register: slurm_node_dir_stat
      with_items: "{{ hostvars['localhost'].slurm_node_log_dirs | default(slurm_node_log_dirs, true) }}"

    - name: Find files under existing slurm node log directories
      ansible.builtin.find:
        paths: "{{ item.item }}"
        file_type: file
        recurse: true
      register: slurm_node_found_files
      when: item.stat.isdir | default(false)
      with_items: "{{ slurm_node_dir_stat.results }}"

    - name: Fetch files from slurm node log directories
      ansible.builtin.fetch:
        src: "{{ item }}"
        dest: "{{ hostvars['localhost'].log_root }}/slurm/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      loop: "{{ slurm_node_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | map(attribute='path') | list }}"
      when: slurm_node_found_files.results | selectattr('files', 'defined') | map(attribute='files') | flatten | length > 0

    - name: Stat slurm node log files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: slurm_node_files
      with_items: "{{ hostvars['localhost'].slurm_node_log_files | default(slurm_node_log_files, true) }}"

    - name: Fetch slurm node log files
      ansible.builtin.fetch:
        src: "{{ item.item }}"
        dest: "{{ hostvars['localhost'].log_root }}/slurm/{{ inventory_hostname }}_{{ hostvars['localhost'].log_ts }}/"
        flat: false
      when: item.stat.isreg | default(false)
      with_items: "{{ slurm_node_files.results }}"
