# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Include openchami cloud-init vars
  ansible.builtin.include_vars: "{{ role_path }}/../../../common/vars/openchami_cloud_init_vars.yml"

- name: Include vars from default
  ansible.builtin.include_vars: "{{ default_file_path }}"

- name: Set the functional_group_name
  ansible.builtin.set_fact:
    functional_group_name: "{{ item }}"

- name: Delete ci group configuration - {{ functional_group_name }}
  ansible.builtin.command: "{{ openchami_cli_path }} {{ openchami_commands.cloud_init_group_delete }} @{{ cloud_init_dir }}/ci-group-{{ functional_group_name }}.yaml"
  changed_when: true
  failed_when: false

- name: Load ci group template
  block:
    - name: Load ci group template - {{ functional_group_name }}
      ansible.builtin.template:
        src: "cloud_init/ci-group-{{ functional_group_name }}.yaml.j2"
        dest: "{{ cloud_init_dir }}/ci-group-{{ functional_group_name }}.yaml"
        mode: "{{ hostvars['localhost']['file_permissions_644'] }}"
  rescue:
    - name: Failed to load ci group template
      ansible.builtin.fail:
        msg: "{{ ci_group_load_fail_msg }}"

- name: Set ci group configuration - {{ functional_group_name }}
  ansible.builtin.command: "{{ openchami_cli_path }} {{ openchami_commands.cloud_init_group_set }} @{{ cloud_init_dir }}/ci-group-{{ functional_group_name }}.yaml"
  changed_when: true

- name: Verify ci group configuration - {{ functional_group_name }}
  ansible.builtin.command: "{{ openchami_cli_path }} {{ openchami_commands.cloud_init_group_get_config }} {{ functional_group_name }}"
  changed_when: false
  register: ci_group_compute_output
  no_log: true

- name: Verify ci group output - {{ functional_group_name }}
  ansible.builtin.debug:
    msg: "{{ ci_group_compute_output.stdout_lines }}"
    verbosity: 2
  no_log: true
